# LiveKit SFU — 3 nodes (c6in.4xlarge: 16 vCPU, 10 Gbps)
# LiveKit handles WebRTC SFU for video delivery from relay SRT to operator browsers.
# Simulcast: vehicle encodes 3 layers (2Mbps / 500Kbps / 150Kbps)
# SFU selects layer per subscriber bandwidth.

replicaCount: 3

image:
  repository: livekit/livekit-server
  tag: "1.7"

config:
  livekit.yaml: |
    port: 7880
    rtc:
      tcp_port: 7881
      port_range_start: 50000
      port_range_end: 60000
      use_external_ip: true
      # STUN servers (fallback — most connections go via TURN)
      stun_servers:
        - "stun.l.google.com:19302"

    # TURN relay via Cloudflare (global PoP coverage, fastest ICE negotiation)
    # Cloudflare TURN endpoint is provisioned separately
    turn:
      enabled: true
      credential_expiry: 86400   # 24h TURN credentials

    # Redis for cluster coordination (3 LiveKit nodes share room state)
    redis:
      address: "redis-cluster:6379"
      password: "${REDIS_PASSWORD}"

    # Ingress: accepts SRT from relay nodes and converts to WebRTC RTP
    ingress:
      enabled: true

    # Egress: records active sessions to S3
    egress:
      enabled: true
      s3:
        bucket: "systemscale-recordings"
        region: "us-east-1"
        access_key: "${AWS_ACCESS_KEY}"
        secret: "${AWS_SECRET_KEY}"

    keys:
      # API key/secret for generating room tokens in fleet-api
      "${LIVEKIT_API_KEY}": "${LIVEKIT_API_SECRET}"

    # Simulcast: allow up to 3 video layers per stream
    room:
      max_participants: 1100  # 1000 vehicles + 100 simultaneous operator sessions
      empty_timeout: 300      # close room after 5 min of inactivity

service:
  type: ClusterIP
  ports:
    http: 7880
    rtc: 7881

# TURN requires UDP/TCP access — handled by separate Cloudflare TURN service

resources:
  requests:
    cpu: "12"
    memory: "24Gi"
  limits:
    cpu: "16"
    memory: "32Gi"

affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchLabels:
            app.kubernetes.io/name: livekit
        topologyKey: kubernetes.io/hostname

podDisruptionBudget:
  enabled: true
  minAvailable: 2
